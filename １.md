はい、承知いたしました。
ご提示いただいたPythonスクリプトの`get_analysis_prompt`関数を、新しく作成した「テキスト読み上げスタイル対応」のプロンプトに差し替える形で修正します。

以前のプロンプトは「動画を**事後分析**する」ためのものでしたが、新しいプロンプトは「テーマから**脚本を生成**する」という目的になっています。

今回の修正では、**「アップロードされた動画を分析し、その動画のテーマに基づいて、改善された新しい脚本を生成する」** という流れになるように、プロンプトを調整しました。これにより、既存のスクリプトの「動画をアップロードして分析する」という流れを活かしつつ、より実践的な「改善脚本」を得られるようになります。

### 修正後のPythonスクリプト

`get_analysis_prompt`関数の中身を以下のように差し替えてください。それ以外の部分は変更不要です。

```python
import google.generativeai as genai
import os
import time
from dotenv import load_dotenv
import markdown

# --- 準備: 環境変数の読み込み ---
load_dotenv()

# --- 1. グローバル設定 ---
try:
    api_key = os.environ["GOOGLE_API_KEY"]
    genai.configure(api_key=api_key)
except KeyError:
    print("エラー: .envファイルに 'GOOGLE_API_KEY' が設定されていません。")
    exit()

VIDEO_FOLDER_PATH = os.getenv("VIDEO_FOLDER_PATH")
if not VIDEO_FOLDER_PATH:
    print("エラー: .envファイルに 'VIDEO_FOLDER_PATH' が設定されていません。")
    exit()

OUTPUT_HTML_DIR = "analysis_reports"

# --- 2. HTMLレポートのテンプレート (変更なし) ---
HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikTok動画改善脚本レポート: {{ video_title }}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            line-height: 1.6;
            background-color: #f6f8fa;
            color: #24292e;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #ffffff;
            border: 1px solid #d1d5da;
            border-radius: 6px;
            padding: 20px 40px;
        }
        h1, h2, h3, h4, h5, h6 {
            border-bottom: 1px solid #eaecef;
            padding-bottom: 0.3em;
            margin-top: 24px;
            margin-bottom: 16px;
            font-weight: 600;
        }
        h1 { font-size: 2em; }
        h2 { font-size: 1.5em; }
        h3 { font-size: 1.25em; }
        table {
            width: 100%;
            border-collapse: collapse;
            display: block;
            overflow-x: auto;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #dfe2e5;
            padding: 8px 12px;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #f6f8fa;
            font-weight: bold;
        }
        tr:nth-child(2n) {
            background-color: #f6f8fa;
        }
        code {
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            background-color: rgba(27,31,35,0.05);
            padding: .2em .4em;
            margin: 0;
            font-size: 85%;
            border-radius: 3px;
        }
        pre {
            background-color: #f6f8fa;
            border-radius: 3px;
            padding: 16px;
            overflow: auto;
            white-space: pre-wrap; /* この行が改行を保持します */
            word-wrap: break-word; /* この行が長い単語を折り返します */
        }
        pre > code {
            background-color: transparent; padding: 0; margin: 0; font-size: 100%; border: 0;
        }
        hr {
            border: 0; height: 1px; background-color: #d1d5da; margin: 24px 0;
        }
        ul, ol { padding-left: 20px; }
        li { margin-bottom: 0.5em; } /* リスト項目間のスペースを調整 */
    </style>
</head>
<body>
    <div class="container">
        <h1>TikTok動画 改善脚本レポート</h1>
        <h2>分析対象: <code>{{ video_title }}</code></h2>
        <hr>
        {{ content }}
    </div>
</body>
</html>
"""

# --- 3. プロンプト生成関数 (テキスト読み上げスタイル対応版に修正) ---
def get_analysis_prompt(goal, target_audience, issue):
    """
    ユーザーからの入力と、動画分析の結果に基づいて、
    Geminiに「改善脚本の生成」を指示する最終的なプロンプトを生成する。
    """
    return f"""
# 命令書
あなたは、YouTube ShortsやTikTokに精通したプロの動画コンサルタント兼、脚本家です。
添付された動画をまず分析し、その動画の良かった点と改善点を簡潔に特定してください。
その上で、その動画のテーマを活かしつつ、あなたの持つ「バズるショート動画の法則」に基づいて、**全面的に改善した新しい脚本**を生成してください。

## ユーザーからの補足情報
- **この動画のゴール:** {goal}
- **ターゲット視聴者:** {target_audience}
- **制作者が感じている課題:** {issue}

# 脚本生成のルール
- **脚本の構成:** 必ず以下の「#改善脚本の構成」フォーマットに従ってください。
- **冒頭の掴み(フック):** 最初の2秒で視聴者を惹きつけ、絶対にスワイプさせない強力なフックを設計してください。
- **テンポと「間」:** 視聴者が情報をストレスなく消化できるよう、テキスト（ナレーション）は時間差で表示させることを前提に設計してください。`（0.5秒後）`のように、タイミングを明記すること。
- **効果音(SE):** テキスト表示や場面転換に合わせて、動画にメリハリをつける効果的な効果音を具体的に提案してください。
- **CTA(行動喚起):** 最後に、視聴者がコメントや保存などのアクションを取りたくなるような、具体的な問いかけで締めくくってください。

---

# 出力フォーマット

## 1. 元動画の簡易分析

### 良かった点 (Good Point)
- （例：テーマ設定が視聴者の興味を引きやすい点）
- （例：映像素材のクオリティが高く、可愛らしい点）

### 改善点 (Improvement Point)
- （例：冒頭の掴みが弱く、離脱されやすい可能性）
- （例：情報提示のテンポが速すぎ、視聴者が内容を理解する前に進んでしまう点）

<hr>

## 2. 改善脚本の提案

### 【動画タイトル案（3案）】
1. （キャッチーなタイトル案1）
2. （問いかけ型のタイトル案2）
3. （意外性を突くタイトル案3）

---

### 【改善脚本】

**【動画の型】:** （例：ランキング型、あるある共感型、対比型など）

**(0-2秒) 掴み (Hook)**
*   **テキスト(ナレーション):** （視聴者が絶対に離脱しない、強烈なインパクトや共感のある一言）
*   **映像イメージ:** （視聴者の目を引く、最も効果的な映像のアップ）
*   **効果音(SE):** （例：ピコン！, キラキラ, 警告音など）
*   **BGM:** （例：緊迫感のあるBGM）

**(3-10秒) 本編1**
*   **テキスト(ナレーション) 1:** （見出しとなる大きなテキスト）
*   **(0.5秒後) テキスト(ナレーション) 2:** （補足説明のポップアップテキスト）
*   **映像イメージ:** （内容に合った映像のアイデア）
*   **効果音(SE):** （テキスト表示に合わせた効果音）

**(11-18秒) 本編2**
*   **テキスト(ナレーション) 1:** （見出し）
*   **(0.5秒後) テキスト(ナレーション) 2:** （補足説明1）
*   **映像イメージ:** 
*   **効果音(SE):** 

...（以降、動画の長さに合わせて本編を構成）...

**(最終5秒) 締め (Call to Action)**
*   **テキスト(ナレーション):** （「〇〇な子はコメントで教えて！」「忘れないように保存してね」など、具体的な行動喚起）
*   **映像イメージ:** （感情に訴えかけるような、可愛い映像のアップ）
*   **効果音(SE):** （コメントを促すような可愛い効果音）

---

### 3. この脚本のポイント（改善意図の解説）
- **フックの改善:** （元の動画のどこを、なぜこのように変更したのかを解説）
- **構成の意図:** （なぜこの構成（例：対比型）を選んだのか、視聴者心理をどう動かすかを解説）
- **情報提示の工夫:** （テキストを時間差で表示することや、効果音(SE)が視聴維持率に与える影響について解説）

"""

# --- 4. ヘルパー関数 (HTMLテンプレートのtitleタグを修正) ---
def create_html_report(markdown_content: str, video_filename: str, output_dir: str):
    try:
        # HTMLのタイトル部分を新しい目的に合わせる
        html_title = f"TikTok動画改善脚本レポート: {video_filename}"
        
        html_content = markdown.markdown(markdown_content, extensions=['markdown.extensions.tables'])
        report_html = HTML_TEMPLATE.replace("{{ video_title }}", video_filename)
        report_html = report_html.replace("<title>TikTok動画分析レポート: {{ video_title }}</title>", f"<title>{html_title}</title>")
        report_html = report_html.replace("<h1>TikTok動画分析レポート</h1>", "<h1>TikTok動画 改善脚本レポート</h1>")
        report_html = report_html.replace("{{ content }}", html_content)
        
        output_filename = os.path.splitext(video_filename)[0] + "_script.html" # ファイル名も変更
        output_filepath = os.path.join(output_dir, output_filename)
        with open(output_filepath, "w", encoding="utf-8") as f:
            f.write(report_html)
        print(f"✅ HTMLレポートが正常に生成されました: {output_filepath}")
    except Exception as e:
        print(f"❌ HTMLレポートの生成中にエラーが発生しました: {e}")

# --- 5. メイン分析関数 (変更なし) ---
def analyze_video_from_path(video_path: str, prompt: str):
    uploaded_file = None
    video_filename = os.path.basename(video_path)
    print("-" * 50)
    print(f"動画ファイル '{video_filename}' の処理を開始します。")
    try:
        print(f"ファイルをアップロード中: {video_path}")
        uploaded_file = genai.upload_file(path=video_path, display_name=video_filename)
        print(f"アップロード完了。File Name: {uploaded_file.name}")
        print("サーバー側でのファイル処理を待機しています...")
        while uploaded_file.state.name == "PROCESSING":
            time.sleep(10)
            uploaded_file = genai.get_file(name=uploaded_file.name)
            print(f"現在の状態: {uploaded_file.state.name}")
        if uploaded_file.state.name != "ACTIVE":
            print(f"エラー: ファイルの処理に失敗しました。状態: {uploaded_file.state.name}")
            return
        print("ファイルの準備が完了しました。")
        print("Geminiによる動画分析と脚本生成を開始します... (最大10分程度かかる場合があります)")
        # モデル名を最新の高性能モデルに指定
        model = genai.GenerativeModel(model_name="models/gemini-1.5-pro-latest")
        response = model.generate_content([uploaded_file, prompt], request_options={"timeout": 600})
        print("\n--- 分析＆改善脚本 (動画コンサルタント KRONOS より) ---")
        print(response.text)
        print("--- 処理終了 ---\n")
        create_html_report(response.text, video_filename, OUTPUT_HTML_DIR)
    except Exception as e:
        print(f"エラー: '{video_filename}' の処理中にエラーが発生しました: {e}")
    finally:
        if uploaded_file:
            try:
                print(f"アップロードされたファイル '{uploaded_file.name}' を削除します。")
                genai.delete_file(name=uploaded_file.name)
                print("ファイルの削除が完了しました。")
            except Exception as e:
                print(f"警告: ファイル '{uploaded_file.name}' の削除に失敗しました: {e}")
    print("-" * 50 + "\n")

# --- 6. メイン実行ブロック (変更なし) ---
if __name__ == "__main__":
    if not os.path.isdir(VIDEO_FOLDER_PATH):
        print(f"エラー: 指定されたフォルダー '{VIDEO_FOLDER_PATH}' が存在しません。")
        exit()
    os.makedirs(OUTPUT_HTML_DIR, exist_ok=True)
    supported_formats = ('.mp4', '.mpeg', '.mov', '.avi', '.flv', '.mpg', '.webm', '.wmv', '.3gpp')
    video_files = [os.path.join(VIDEO_FOLDER_PATH, f) for f in os.listdir(VIDEO_FOLDER_PATH) if f.lower().endswith(supported_formats)]
    if not video_files:
        print(f"フォルダー '{VIDEO_FOLDER_PATH}' に動画が見つかりませんでした。")
    else:
        print(f"分析対象の動画が {len(video_files)} 件見つかりました。")
        for i, video_file in enumerate(video_files):
            print(f"\n[{i+1}/{len(video_files)}] 次の動画の分析準備をします: {os.path.basename(video_file)}")
            print("この動画に関する情報を入力してください (Enterキーのみでスキップ可):")
            goal = input("  - 動画のゴール (例: 商品購入, フォロワー獲得): ") or "指定なし"
            target_audience = input("  - ターゲット視聴者像 (例: 20代女性, 筋トレ好き男性): ") or "指定なし"
            issue = input("  - 現状の課題・悩み (例: 視聴維持率が低い): ") or "指定なし"
            final_prompt = get_analysis_prompt(goal, target_audience, issue)
            analyze_video_from_path(video_file, final_prompt)
        print("🎉 すべての動画の分析と脚本生成が完了しました。")
        print(f"レポートは '{OUTPUT_HTML_DIR}' フォルダに保存されています。")
```

### 主な変更点

1.  **`get_analysis_prompt`関数:**
    *   プロンプトの内容を、新しい「改善脚本生成」の指示に全面的に書き換えました。
    *   `goal`, `target_audience`, `issue` のユーザー入力を、プロンプト内の「ユーザーからの補足情報」セクションに埋め込むようにしました。

2.  **`create_html_report`関数:**
    *   生成されるHTMLファイルのタイトルを `TikTok動画改善脚本レポート` に変更しました。
    *   出力ファイル名に `_script.html` という接尾辞をつけ、元の分析レポートと区別できるようにしました。

3.  **モデル名の変更:**
    *   `analyze_video_from_path`関数内で、より高性能で長文の指示理解に優れている可能性のある `models/gemini-1.5-pro-latest` にモデル名を変更しました。（`gemini-1.5-pro`でも動作しますが、`latest`を指定することで常に最新版を利用できます）

これで、スクリプトを実行すると、アップロードされた動画を元に、改善された新しい脚本がHTML形式で出力されるようになります。